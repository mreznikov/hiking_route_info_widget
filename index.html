<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>IsraelHiking.org.il Route Details Fetcher</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background-color: #f0f0f0; color: #333; }
        #status { margin-top: 10px; padding: 8px; background-color: #fff; border-radius: 4px; min-height: 40px; white-space: pre-wrap; border: 1px solid #ddd; }
        .processing { color: #007bff; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        p { font-size: 0.9em; }
    </style>
</head>
<body>
    <h3>Получение данных маршрута с IsraelHiking.org.il</h3>
    <p>Выберите строку в таблице или измените ссылку в колонке 'R' для загрузки деталей маршрута.</p>
    <p><b>Важно:</b> Если данные не загружаются, проверьте консоль разработчика (F12) на наличие ошибок CORS.</p>
    <div id="status">Ожидание выбора записи...</div>

    <script>
        const WIDGET_VERSION = "v2.1.0";
        console.log(`DEBUG: Grist IsraelHiking Details Fetcher Загружен - Версия ${WIDGET_VERSION}`);

        let currentTable1Id = null; 
        const URL_COL_ID = "R";                 
        const DISTANCE_COL_ID = "AD";           
        const ASCENT_COL_ID = "AE";             
        const DESCENT_COL_ID = "AF";            

        const statusDiv = document.getElementById('status');

        /**
         * Извлекает числовой trackId из HTML-контента страницы share.
         */
        function extractTrackIdFromHtml(htmlText) {
            // Ищем: window.IHMapPostData = {"trackId":12345,...};
            // или window.IHMapPostData={"trackId":12345,...};
            const match = htmlText.match(/window\.IHMapPostData\s*=\s*\{.*?\"trackId\"\s*:\s*(\d+).*?\}/s);
            if (match && match[1]) {
                console.log("DEBUG: Найден trackId:", match[1]);
                return match[1];
            }
            console.warn("DEBUG: trackId не найден в window.IHMapPostData.");
            return null;
        }

        async function fetchRouteDetailsFromApi(trackId) {
            const apiUrl = `https://israelhiking.osm.org.il/api/Tracks/Details/${trackId}`;
            console.log(`DEBUG: Запрос к API: ${apiUrl}`);
            statusDiv.innerHTML += `\nЗапрос деталей трека ID ${trackId} через API...`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Ошибка API Tracks/Details: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log("DEBUG: Ответ от API Tracks/Details:", data);

                if (data && typeof data.length === 'number' && typeof data.ascent === 'number' && typeof data.descent === 'number') {
                    const distanceKm = (data.length / 1000).toFixed(1);
                     statusDiv.innerHTML += `\nAPI вернул: Дистанция ${distanceKm} км, Подъем ${data.ascent} м, Спуск ${data.descent} м.`;
                    return {
                        distance: parseFloat(distanceKm),
                        ascent: data.ascent,
                        descent: data.descent
                    };
                } else {
                    console.error("API Tracks/Details не вернул ожидаемые поля length, ascent, descent.");
                    statusDiv.innerHTML += `\nОшибка: API Tracks/Details не вернул нужные данные.`;
                    return null;
                }
            } catch (error) {
                console.error("ОШИБКА при запросе к API Tracks/Details:", error);
                statusDiv.innerHTML += `\nОШИБКА API: ${error.message}`;
                return null;
            }
        }

        async function fetchAndProcessRouteUrl(routeUrl) {
            if (!routeUrl || !routeUrl.startsWith("https://israelhiking.osm.org.il/share/")) {
                statusDiv.textContent = "Ошибка: Неверный формат URL."; statusDiv.className = 'error';
                return null;
            }

            statusDiv.textContent = `Этап 1: Загрузка страницы ${routeUrl} для извлечения trackId...`; 
            statusDiv.className = 'processing';
            console.log(`DEBUG: Попытка загрузить HTML с: ${routeUrl}`);

            try {
                const response = await fetch(routeUrl); 
                if (!response.ok) {
                    throw new Error(`Ошибка сети при загрузке share-страницы: ${response.status} ${response.statusText}`);
                }
                const htmlText = await response.text();
                console.log("DEBUG: HTML share-страницы успешно загружен.");

                const trackId = extractTrackIdFromHtml(htmlText);
                if (!trackId) {
                    statusDiv.textContent = "Ошибка: Не удалось извлечь числовой trackId со страницы share."; 
                    statusDiv.className = 'error';
                    return null;
                }
                
                // Теперь, имея trackId, запрашиваем детали через API
                return await fetchRouteDetailsFromApi(trackId);

            } catch (error) {
                console.error("ОШИБКА на Этапе 1 (загрузка share-страницы или извлечение trackId):", error);
                if (String(error.message).toLowerCase().includes('failed to fetch') || error.name === 'NetworkError') {
                     statusDiv.textContent = "ОШИБКА: Не удалось загрузить share-страницу. Вероятно, проблема CORS или сети.";
                } else {
                    statusDiv.textContent = `ОШИБКА: ${error.message}`;
                }
                statusDiv.className = 'error';
                return null;
            }
        }

        async function handleTable1Record(record, mappings) {
            if (!record || !record.id) {
                statusDiv.textContent = "Запись не выбрана."; statusDiv.className = ''; return;
            }
            if (mappings && mappings.tableId && mappings.tableId !== currentTable1Id) {
                currentTable1Id = mappings.tableId;
            }
             if (!currentTable1Id && grist.selectedTable && typeof grist.selectedTable.getTableId === 'function') {
                try { currentTable1Id = await grist.selectedTable.getTableId(); } catch(e){}
            }
            if (!currentTable1Id && optionsFromInit && optionsFromInit.tableId) { 
                 currentTable1Id = optionsFromInit.tableId;
            }


            if (!currentTable1Id) {
                 console.error("ОШИБКА: currentTable1Id не установлен. Невозможно обновить запись.");
                 statusDiv.textContent = "Ошибка: ID таблицы не определен."; statusDiv.className = 'error';
                 return;
            }

            console.log("DEBUG: Выбрана/изменена запись в Table1:", record, "ID таблицы:", currentTable1Id);

            const routeUrl = record[URL_COL_ID];
            if (!routeUrl) {
                statusDiv.textContent = `В колонке '${URL_COL_ID}' нет URL для записи ID ${record.id}.`;
                statusDiv.className = 'warning';
                const clearPayload = {
                    [DISTANCE_COL_ID]: null, [ASCENT_COL_ID]: null, [DESCENT_COL_ID]: null
                };
                try {
                    await grist.docApi.applyUserActions([['UpdateRecord', currentTable1Id, record.id, clearPayload]]);
                } catch(e) { console.error("Ошибка при очистке полей:", e); }
                return;
            }

            const routeDetails = await fetchAndProcessRouteUrl(routeUrl);

            if (routeDetails) {
                const updatePayload = {};
                if (typeof routeDetails.distance === 'number' && record[DISTANCE_COL_ID] != routeDetails.distance) updatePayload[DISTANCE_COL_ID] = routeDetails.distance;
                if (typeof routeDetails.ascent === 'number' && record[ASCENT_COL_ID] != routeDetails.ascent) updatePayload[ASCENT_COL_ID] = routeDetails.ascent;
                if (typeof routeDetails.descent === 'number' && record[DESCENT_COL_ID] != routeDetails.descent) updatePayload[DESCENT_COL_ID] = routeDetails.descent;
                
                if (record[DISTANCE_COL_ID] == null && typeof routeDetails.distance === 'number') updatePayload[DISTANCE_COL_ID] = routeDetails.distance;
                if (record[ASCENT_COL_ID] == null && typeof routeDetails.ascent === 'number') updatePayload[ASCENT_COL_ID] = routeDetails.ascent;
                if (record[DESCENT_COL_ID] == null && typeof routeDetails.descent === 'number') updatePayload[DESCENT_COL_ID] = routeDetails.descent;

                if (Object.keys(updatePayload).length > 0) {
                    try {
                        console.log(`DEBUG: Обновление записи ID ${record.id} в ${currentTable1Id} данными:`, updatePayload);
                        await grist.docApi.applyUserActions([['UpdateRecord', currentTable1Id, record.id, updatePayload]]);
                        statusDiv.innerHTML += `<br>Данные для маршрута ID ${record.id} обновлены в Grist.`;
                        statusDiv.className = 'success';
                    } catch (e) {
                        console.error("ОШИБКА при обновлении записи в Grist:", e);
                        statusDiv.textContent = `Ошибка записи данных в Grist: ${e.message}`;
                        statusDiv.className = 'error';
                    }
                } else {
                     console.log(`DEBUG: Данные для записи ID ${record.id} не изменились или невалидны. Обновление Grist не требуется.`);
                     statusDiv.innerHTML += `<br>Данные для маршрута ID ${record.id} не изменились.`;
                }
            }
        }
        
        let optionsFromInit = null; // Для хранения options из самого первого вызова onOptions

        async function initGrist() {
            console.log("DEBUG: initGrist() called");
            if (typeof grist === 'undefined' || !grist.ready) {
                console.error("Grist API не найден."); statusDiv.textContent = "Ошибка: Grist API не найден."; return;
            }
            try {
                await grist.ready({
                    requiredAccess: 'full',
                    columns: [ 
                        { name: URL_COL_ID, type: 'Text' },
                        { name: DISTANCE_COL_ID, type: 'Numeric', optional: true },
                        { name: ASCENT_COL_ID, type: 'Numeric', optional: true },
                        { name: DESCENT_COL_ID, type: 'Numeric', optional: true },
                    ]
                });
                console.log("DEBUG: grist.ready() завершен.");

                grist.onOptions(async (options, interaction) => {
                    console.log("DEBUG: grist.onOptions вызвана. options:", options, "interaction:", interaction);
                    if(!optionsFromInit && options) optionsFromInit = options; // Сохраняем самые первые options

                    let tableIdFromEvent = (options?.tableId) || (interaction?.tableId) || null;
                    if (tableIdFromEvent) {
                        currentTable1Id = tableIdFromEvent;
                        console.log(`DEBUG: ID основной таблицы установлен через onOptions/interaction: ${currentTable1Id}`);
                    } else if (grist.selectedTable && typeof grist.selectedTable.getTableId === 'function') {
                        try { 
                            currentTable1Id = await grist.selectedTable.getTableId();
                            if(currentTable1Id) console.log(`DEBUG: ID основной таблицы установлен через grist.selectedTable.getTableId(): ${currentTable1Id}`);
                        } catch (e) { console.error("Ошибка grist.selectedTable.getTableId():", e); }
                    }
                    
                    if (!currentTable1Id) {
                        console.error("ОШИБКА КРИТИЧЕСКАЯ: ID основной таблицы (Table1) НЕ УСТАНОВЛЕН. Убедитесь, что виджет привязан к таблице в настройках.");
                        statusDiv.textContent = "Ошибка конфигурации: виджет не связан с таблицей.";
                    }
                });
                
                grist.onRecord(handleTable1Record); 
                console.log(`DEBUG: Установлен обработчик grist.onRecord.`);
                
                console.log(`DEBUG: Grist API настроен и готов. Версия виджета: ${WIDGET_VERSION}`);
                statusDiv.textContent = "Виджет готов. Выберите строку или измените URL в колонке 'R'.";
            } catch (err) {
                console.error("Ошибка при grist.ready() или начальной настройке:", err);
                statusDiv.textContent = "Ошибка инициализации виджета.";
            }
        }
        initGrist();
    </script>
</body>
</html>
